authelia:
  image:
    tag: "4.39.13"

  secret:
    existingSecret: "authelia-secrets"
    additionalSecrets:
      authelia-secrets: {}

  configMap:
    authentication_backend:
      password_reset:
        disable: true
      ldap:
        enabled: true
        address: "ldap://lldap:3890"
        implementation: "custom"
        timeout: "5 seconds"
        start_tls: false
        base_dn: "dc=linkopingsfallskarmsklubb,dc=se"
        additional_users_dn: "ou=people"
        users_filter: "(&(|({username_attribute}={input})(mail={input}))(objectClass=person))"
        additional_groups_dn: "ou=groups"
        groups_filter: "(member={dn})"
        attributes:
          display_name: "displayName"
          username: "uid"
          mail: "mail"
          group_name: "cn"
        user: "uid=admin,ou=people,dc=linkopingsfallskarmsklubb,dc=se"
        password:
          secret_name: "authelia-secrets"
          path: "ldap-password"

    storage:
      encryption_key:
        secret_name: "authelia-secrets"
        path: "storage-encryption-key"
      postgres:
        enabled: true
        address: "tcp://pg.core.svc.cluster.local:5432"
        database: "authelia"
        username: "authelia"
        password:
          secret_name: "authelia-secrets"
          path: "postgres-password"

    session:
      name: "authelia_session"
      cookies:
        - domain: "linkopingsfallskarmsklubb.se"
          authelia_url: "https://auth.linkopingsfallskarmsklubb.se"
      encryption_key:
        secret_name: "authelia-secrets"
        path: "session-secret"

    identity_validation:
      reset_password:
        secret:
          secret_name: "authelia-secrets"
          path: "jwt-secret"

    password_policy:
      standard:
        enabled: true
        min_length: 12
        require_uppercase: true
        require_lowercase: true
        require_number: true
        require_special: true

    webauthn:
      display_name: "Linköpings Fallskärmsklubb"

    identity_providers:
      oidc:
        enabled: true
        hmac_secret:
          secret_name: "authelia-secrets"
          path: "oidc-hmac-secret"
        jwks:
          - key:
              path: "/secrets/authelia-secrets/oidc-issuer-private-key"
        clients:
          - client_id: "argocd"
            client_name: "ArgoCD"
            client_secret:
              path: "/secrets/authelia-secrets/client-argocd-secret"
            public: false
            authorization_policy: "one_factor"
            redirect_uris:
              - "https://insidan.linkopingsfallskarmsklubb.se/argocd/api/dex/callback"
            scopes: ["openid", "profile", "email", "groups"]
          - client_id: "skywinone"
            client_name: "Skywin One"
            client_secret:
              path: "/secrets/authelia-secrets/client-skywinone-secret"
            public: false
            authorization_policy: "one_factor"
            redirect_uris:
              - "https://insidan.linkopingsfallskarmsklubb.se/skywinone/oidc/callback"
              - "https://insidan.linkopingsfallskarmsklubb.se/skywinone/oidc/callback/"
            scopes: ["openid", "profile", "email", "groups"]
          - client_id: "insidan"
            client_name: "Insidan"
            client_secret:
              path: "/secrets/authelia-secrets/client-insidan-secret"
            public: false
            authorization_policy: "one_factor"
            redirect_uris:
              - "https://insidan.linkopingsfallskarmsklubb.se/api/auth/callback"
              - "https://insidan.linkopingsfallskarmsklubb.se/auth/callback"
            scopes: ["openid", "profile", "email", "groups", "offline_access"]
            refresh_token: true

    notifier:
      disable_startup_check: true
      smtp:
        enabled: true
        address: "submission://smtp-relay.gmail.com:587"
        sender: "LFK Accounts <do-not-reply@linkopingsfallskarmsklubb.se>"

    access_control:
      default_policy: "deny"
      rules:
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          resources: ["^/skywinone($|/.*)"]
          subject: ["group:skywin_users"]
          policy: "two_factor"
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          resources: ["^/argocd($|/.*)"]
          subject: ["group:admins"]
          policy: "two_factor"
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          subject: ["group:users"]
          policy: "two_factor"
        - domain: "auth.linkopingsfallskarmsklubb.se"
          policy: "two_factor"
        - domain: "localhost"
          subject: ["group:admins"]
          policy: "two_factor"
        - domain: "*.linkopingsfallskarmsklubb.se"
          subject: ["group:users"]
          policy: "two_factor"

  ingress:
    enabled: true
    className: "traefik"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls.certresolver: default

secretStore: secret-store

# Secrets references in GCP SM
secrets:
  jwtSecret: authelia-jwt-secret
  sessionSecret: authelia-session-secret
  storageEncryptionKey: authelia-storage-encryption-key
  oidcIssuerPrivateKey: authelia-oidc-issuer-private-key
  oidcHmacSecret: authelia-oidc-hmac-secret
  postgresPassword: authelia-postgres-password
  lldapAdminPassword: lldap-user-pass

# OIDC Clients
clients:
  - id: argocd
    name: ArgoCD
    secretRef: authelia-client-argocd-secret
    redirect_uris:
      - https://insidan.linkopingsfallskarmsklubb.se/argocd/api/dex/callback
  - id: skywinone
    name: Skywin One
    secretRef: authelia-client-skywinone-secret
    redirect_uris:
      - https://insidan.linkopingsfallskarmsklubb.se/skywinone/oidc/callback
  - id: insidan
    name: Insidan
    secretRef: authelia-client-insidan-secret
    redirect_uris:
      - https://insidan.linkopingsfallskarmsklubb.se/api/auth/callback
