apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Release.Name }}-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: {{ .Values.secretStore }}
    kind: ClusterSecretStore
  target:
    name: {{ .Release.Name }}-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        configuration.yml: |
          server:
            address: tcp://0.0.0.0:9091
          log:
            level: debug
          identity_validation:
            reset_password:
              jwt_secret: "{{"{{"}} .jwt_secret | trim {{"}}"}}"
          authentication_backend:
            password_reset:
              disable: true
            ldap:
              address: {{ .Values.lldap.address }}
              implementation: custom
              timeout: 5s
              start_tls: false
              base_dn: {{ .Values.lldap.base_dn }}
              additional_users_dn: ou=people
              users_filter: "(&(|({username_attribute}={input})(mail={input}))(objectClass=person))"
              additional_groups_dn: ou=groups
              groups_filter: "(member={dn})"
              group_search_mode: filter
              attributes:
                display_name: displayName
                username: uid
                mail: mail
                group_name: cn
              user: {{ .Values.lldap.user }}
              password: "{{"{{"}} .lldap_password | trim {{"}}"}}"
          storage:
            postgres:
              address: tcp://{{ .Values.postgres.host }}:{{ .Values.postgres.port }}
              database: {{ .Values.postgres.database }}
              username: {{ .Values.postgres.user }}
              password: "{{"{{"}} .postgres_password | trim {{"}}"}}"
          session:
            name: authelia_session
            expiration: 1h
            inactivity: 5m
            remember_me: 1M
            cookies:
              - domain: {{ .Values.domain | replace "auth." "" }}
                authelia_url: https://{{ .Values.domain }}
            secret: "{{"{{"}} .session_secret | trim {{"}}"}}"
          storage_encryption_key: "{{"{{"}} .storage_encryption_key | trim {{"}}"}}"
          notifier:
            filesystem:
              filename: /tmp/notification.txt
          identity_providers:
            oidc:
              hmac_secret: "{{"{{"}} .oidc_hmac_secret | trim {{"}}"}}"
              jwks:
                - key: |
                    {{"{{"}} .oidc_issuer_private_key | nindent 20 {{"}}"}}
              cors:
                endpoints:
                  - authorization
                  - token
                  - revocation
                  - introspection
                allowed_origins:
                  - https://insidan.linkopingsfallskarmsklubb.se
              clients:
                {{- range .Values.clients }}
                - client_id: {{ .id }}
                  client_name: {{ .name }}
                  client_secret: "{{"{{"}} .client_{{ .id | replace "-" "_" }}_secret | trim {{"}}"}}"
                  public: false
                  authorization_policy: one_factor
                  redirect_uris:
                    {{- range .redirect_uris }}
                    - {{ . }}
                    {{- end }}
                  scopes:
                    - openid
                    - profile
                    - email
                    - groups
                  userinfo_signed_response_alg: none
                  pkce_challenge_method: S256
                {{- end }}
          access_control:
            default_policy: deny
            rules:
              - domain: "insidan.linkopingsfallskarmsklubb.se"
                resources: ["^/skywinone($|/.*)"]
                subject: ["group:skywin_users"]
                policy: one_factor
              - domain: "insidan.linkopingsfallskarmsklubb.se"
                resources: ["^/argocd($|/.*)"]
                subject: ["group:admins"]
                policy: one_factor
              - domain: "insidan.linkopingsfallskarmsklubb.se"
                subject: ["group:users"]
                policy: one_factor
              - domain: "auth.linkopingsfallskarmsklubb.se"
                policy: one_factor
              - domain: "localhost"
                subject: ["group:admins"]
                policy: one_factor
              - domain: "*.linkopingsfallskarmsklubb.se"
                subject: ["group:users"]
                policy: one_factor
  data:
    - secretKey: jwt_secret
      remoteRef:
        key: {{ .Values.secrets.jwtSecret }}
    - secretKey: session_secret
      remoteRef:
        key: {{ .Values.secrets.sessionSecret }}
    - secretKey: storage_encryption_key
      remoteRef:
        key: {{ .Values.secrets.storageEncryptionKey }}
    - secretKey: oidc_issuer_private_key
      remoteRef:
        key: {{ .Values.secrets.oidcIssuerPrivateKey }}
    - secretKey: oidc_hmac_secret
      remoteRef:
        key: {{ .Values.secrets.oidcHmacSecret }}
    - secretKey: postgres_password
      remoteRef:
        key: {{ .Values.secrets.postgresPassword }}
    - secretKey: lldap_password
      remoteRef:
        key: {{ .Values.secrets.lldapAdminPassword }}
    {{- range .Values.clients }}
    - secretKey: client_{{ .id | replace "-" "_" }}_secret
      remoteRef:
        key: {{ .secretRef }}
    {{- end }}
