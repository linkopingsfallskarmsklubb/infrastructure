apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
data:
  configuration.yml: |
    server:
      address: tcp://0.0.0.0:9091

    log:
      level: debug

    identity_validation:
      reset_password:
        # jwt_secret is provided via AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE

    authentication_backend:
      password_reset:
        disable: true
      ldap:
        address: {{ .Values.lldap.address }}
        implementation: custom
        timeout: 5s
        start_tls: false
        base_dn: {{ .Values.lldap.base_dn }}
        additional_users_dn: ou=people
        users_filter: "(&(|({username_attribute}={input})(mail={input}))(objectClass=person))"
        additional_groups_dn: ou=groups
        groups_filter: "(member={dn})"
        group_search_mode: filter
        attributes:
          display_name: displayName
          username: uid
          mail: mail
          group_name: cn
        user: {{ .Values.lldap.user }}
        # password is provided via AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD_FILE

    storage:
      postgres:
        address: tcp://{{ .Values.postgres.host }}:{{ .Values.postgres.port }}
        database: {{ .Values.postgres.database }}
        username: {{ .Values.postgres.user }}
        # password is provided via AUTHELIA_STORAGE_POSTGRES_PASSWORD_FILE

    session:
      name: authelia_session
      expiration: 1h
      inactivity: 5m
      remember_me: 1M
      cookies:
        - domain: {{ .Values.domain | replace "auth." "" }}
          authelia_url: https://{{ .Values.domain }}

    notifier:
      filesystem:
        filename: /tmp/notification.txt

    identity_providers:
      oidc:
        # jwks is provided via AUTHELIA_IDENTITY_PROVIDERS_OIDC_JWKS_0_KEY_FILE
        cors:
          endpoints:
            - authorization
            - token
            - revocation
            - introspection
          allowed_origins:
            - https://insidan.linkopingsfallskarmsklubb.se
        clients:
          {{- range .Values.clients }}
          - client_id: {{ .id }}
            client_name: {{ .name }}
            # client_secret is provided via AUTHELIA_IDENTITY_PROVIDERS_OIDC_CLIENTS_{index}_CLIENT_SECRET_FILE
            public: false
            authorization_policy: one_factor
            redirect_uris:
              {{- range .redirect_uris }}
              - {{ . }}
              {{- end }}
            scopes:
              - openid
              - profile
              - email
              - groups
            userinfo_signed_response_alg: none
            pkce_challenge_method: S256
          {{- end }}

    access_control:
      default_policy: deny
      rules:
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          resources: ["^/skywinone($|/.*)"]
          subject: ["group:skywin_users"]
          policy: one_factor
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          resources: ["^/argocd($|/.*)"]
          subject: ["group:admins"]
          policy: one_factor
        - domain: "insidan.linkopingsfallskarmsklubb.se"
          subject: ["group:users"]
          policy: one_factor
        - domain: "auth.linkopingsfallskarmsklubb.se"
          policy: one_factor
        - domain: "localhost"
          subject: ["group:admins"]
          policy: one_factor
        - domain: "*.linkopingsfallskarmsklubb.se"
          subject: ["group:users"]
          policy: one_factor
